<!DOCTYPE html>
<html lang="en">

    <head>
        <link rel="stylesheet" href="./mapUtility.css">
        <link rel="stylesheet" href="./universal.css">
        <div id="app-title">
            <img src="./content/mordhauforge_full.png" alt="MordhauForge" style="width:80%">
        </div>
        <button class="button" id="home">Home</button> <br/>
    </head>

    <body>
        
        <button class="collapsible">Settings</button>
        <div class="content">
            <div class="contentColl">
                <div class="settingsDiv">
                    <b class="smallTitle">Mordhau Folder:</b><br/>
                    <b id="destinationString"></b><br/>
                    <button id="destinationButton">Browse</button><br/>
                </div>
                <div class="settingsDiv">
                    <div id="secondinstallDiv">
                        <input type="checkbox" id="installSecondaryBox">Install to Secondary Folder<br/>
                    </div>
                    <b class="smallTitle">Secondary Folder:</b><br/>
                    <b id="destinationStringSec"></b><br/>
                    <button id="destinationButtonSec">Browse</button><br/>
                </div>
            </div>
        </div>
        </br>
        <div id="mapcontent">

        </div>


    </body>
    <script>

        const electron = require("electron")
        const {dialog} = electron.remote;

        const {ipcRenderer} = electron;

        const download = require('download');

        var mapData = {};
        var contentFolder = "\\Mordhau\\Content\\Mordhau";
        var mordhaudir = "C:\\Program Files (x86)\\Steam\\steamapps\\common\\Mordhau";
        var installSecDirBool = false;
        var installSecondary = null;

        /// Utility Functions
        function refreshData() {
            ipcRenderer.send('open:import');
        }

        function updateDestination() {
            document.getElementById("destinationString").innerHTML = mordhaudir;
            if ( installSecondary == null ) {
                document.getElementById("destinationStringSec").innerHTML = "No Directory Selected";
            } else {
                document.getElementById("destinationStringSec").innerHTML = installSecondary;
            }
        }

        function updateRender() {
            var s = '';

            for( var i = 0; i < mapData.length; i++) {
                s = s + "</br><div class='mapTitle'><b>" + mapData[i]["_doc"].name + "</b></div>";
                s = s + "<div class='mapBanner'><img src='"+mapData[i]["_doc"].banner+"' class='mapBannerIMG'> </div>";
                s = s + "<div class='mapUtil'><button class='mapInstall' id='install" + i + "'>Install</button>"
                s = s + "<b>Version: " + mapData[i]["_doc"].version + " | Author: " + mapData[i]["_doc"].author + "</b> </div>";
            }

            return s;
        }

        function installsInit() {
            for (var i = 0; i < mapData.length; i++){

                console.log(i);
                
                (function () {

                    var k = "install" + i;
                    var u = mapData[i]["_doc"].url;
                    
                    console.log(k);

                    document.getElementById(k).addEventListener("click", (e) => {       
                        downloadMap(u);
                    });

                }());

            }
        }

        function downloadMap( l ) {
            download(l, 'maps').then(() => {
                console.log('downloaded file');
            });
        }

        function installMap() {
            
        }

        // Hooks
        document.getElementById("home").addEventListener("click", (e) => {
            ipcRenderer.send('open:home');
        });

        document.getElementById("installSecondaryBox").addEventListener("change", (e) => {
            if ( installSecDirBool == false ) {
                installSecDirBool = true;
                console.log(installSecDirBool);
            } else {
                installSecDirBool = false;
                console.log(installSecDirBool);
            }
        });

        document.getElementById("destinationButton").addEventListener("click", () => {

            dialog.showOpenDialog({ properties: ['openDirectory'] }, function(dir) {
                if( dir != undefined ) {
                    mordhaudir = dir[0];
                }
                updateDestination();
            });

        }, false);

        document.getElementById("destinationButtonSec").addEventListener("click", () => {

        dialog.showOpenDialog({ properties: ['openDirectory'] }, function(dir) {
            if( dir != undefined ) {
                installSecondary = dir[0];
            }
            updateDestination();
        });

        }, false);

        /// IpcRenderers

        // Import
        ipcRenderer.on('open:import-reply', (event, arg) => {
            console.log(arg[1]);
            mapData = arg;
            document.getElementById("mapcontent").outerHTML = updateRender();
            installsInit();
        })
        //


        /// Initialization
        refreshData();
        updateDestination();
        

        //////////////////
        ///  Collapse  ///
        //////////////////

        var coll = document.getElementsByClassName("collapsible");
        var i;

        for (i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.display === "block") {
                content.style.display = "none";
                } else {
                content.style.display = "block";
                }
            });
        }

    </script>

</html>